<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <title>Table</title>

    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://use.fontawesome.com/releases/v5.6.3/css/all.css"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/bootstrap-table@1.19.1/dist/bootstrap-table.min.css"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/bootstrap-table@1.19.1/dist/extensions/fixed-columns/bootstrap-table-fixed-columns.css"
    />
    <link rel="stylesheet" href="./bootstrap-editable.css" />
    <link rel="stylesheet" href="./table.css" />
  </head>
  <body>
    <div style="padding: 30px"></div>

    <div style="padding: 20px">
      <table
        data-toggle="table"
        id="table"
        data-detail-view="true"
        data-search="true"
        data-show-export="true"
        data-fixed-columns="true"
        data-fixed-number="3"
        data-detail-formatter="detailFormatter"
      >
        <thead>
          <tr>
            <th data-field="id">Id</th>
            <th data-field="name">Name</th>
            <th data-field="city">City</th>
            <th data-field="region">Region</th>
            <th data-field="education">Education</th>
            <th data-field="age">Age</th>
            <th data-field="fake1">Fake1</th>
            <th data-field="fake2">Fake2</th>
            <th data-field="fake3">Fake3</th>
            <th data-field="fake4">Fake4</th>
            <th data-field="fake5">Fake5</th>
            <th data-field="fake1">Fake6</th>
            <th data-field="fake2">Fake7</th>
            <th data-field="fake3">Fake8</th>
            <th data-field="fake4">Fake9</th>
            <th data-field="fake5">Fake10</th>
          </tr>
        </thead>
      </table>
    </div>
    <div
      class="modal fade bd-example-modal-lg"
      tabindex="-1"
      role="dialog"
      aria-labelledby="myLargeModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-body">
            <form>
              <div class="form-group">
                <label for="recipient-name" class="col-form-label"
                  >Recipient:</label
                >
                <input type="text" class="form-control" id="recipient-name" />
              </div>
              <div class="form-group">
                <label for="message-text" class="col-form-label"
                  >Message:</label
                >
                <textarea class="form-control" id="message-text"></textarea>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <script src="https://unpkg.com/bootstrap-table@1.19.1/dist/bootstrap-table.min.js"></script>
    <script src="https://unpkg.com/bootstrap-table@1.19.1/dist/extensions/editable/bootstrap-table-editable.min.js"></script>
    <script src="./bootstrap-editable.js"></script>
    <script src="./bootstrap-editable.min.js"></script>

    <script src="https://unpkg.com/bootstrap-table@1.19.1/dist/extensions/fixed-columns/bootstrap-table-fixed-columns.js"></script>
    <!-- Export -->
    <script src="https://cdn.jsdelivr.net/npm/tableexport.jquery.plugin@1.10.21/tableExport.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tableexport.jquery.plugin@1.10.21/libs/jsPDF/jspdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tableexport.jquery.plugin@1.10.21/libs/jsPDF-AutoTable/jspdf.plugin.autotable.js"></script>
    <script src="https://unpkg.com/bootstrap-table@1.19.1/dist/extensions/export/bootstrap-table-export.min.js"></script>
    <!-- Export -->
    <script src="./mockTable.js"></script>
    <script>

      $(function () {
        $("#table")
          .bootstrapTable("destroy")
          .bootstrapTable({
            data: data,
            showColumns: true,
            exportDataType: $(this).val(),
            exportTypes: ["excel", "pdf"],
            columns: [
              {
                field: "state",
                visible: true,
              },
            ],
          });

        const table = document.getElementById("table");
        for (let i in table.rows) {
          let row = table.rows[i];
          if (row.rowIndex !== 0) {
            for (let j in row.cells) {
              let col = row.cells[j];
             
              if (col.cellIndex !== undefined) {
                col.setAttribute("id", data[row.rowIndex -1].id + "-" + Object.keys(data[row.rowIndex -1])[col.cellIndex -1]);
              }
             
              if (col.cellIndex === 6) {
                col.setAttribute("data-toggle", "modal");
                col.setAttribute("data-target", ".bd-example-modal-lg");
              }
              if (col.cellIndex === 8) {
                col.setAttribute("data-toggle", "tooltip");
                col.setAttribute("data-html", "true");
                col.setAttribute(
                  "title",
                  "<div>" + col.innerHTML + " + ----<br/>sdfsdf </div>"
                );
              }
            }
          }
        }


        const tbody = document.querySelector("tbody");
        if (tbody) {
          tbody.addEventListener("click", function (e) {
            const cell = e.target.closest("td");
            if (!cell) {
              return;
            }

            const row = cell.parentElement;
            if (cell.cellIndex === 6) {
              $("#recipient-name").val(cell.innerHTML);
            }
            if (cell.cellIndex === 8) {
              $("#recipient-name").val(cell.innerHTML);
            }
            /*Tablo detayına tıklanmışsa true gidecek*/
            editTable(row.className !== "detail-tr" ? false : true,e.target.id, cell.id);
        
          });
        }

        $('[data-toggle="tooltip"]').tooltip();
        
        $("#exampleModalCenter").on("shown.bs.modal", function () {
          $("#exampleModalCenter").trigger("focus");
        });
      });

      function detailFormatter(index, row) {
        let detailTable = document.createElement("table");

        let detailTableBody = document.createElement("tbody");

        dataDetail[row.id].map((item, dTIndex) => {
          
          let firstColumnWidth = document.getElementById("table").rows[1].cells[0].offsetWidth;
          var tr = document.createElement("tr");
          tr.setAttribute("class", "detail-tr");

          var firstTd = document.createElement("td");
          firstTd.setAttribute("style", "width:" + firstColumnWidth + "px;");
          tr.appendChild(firstTd);

          let i = 1;

          for (const [key, value] of Object.entries(item)) {
            let columnWidth = document.getElementById("table").rows[1].cells[i].offsetWidth;
            var td = document.createElement("td");
            td.innerHTML = value;
            td.setAttribute("style", "width:" + columnWidth + "px;");
            td.setAttribute("id", item.id + "-" + key);
            tr.appendChild(td);
            i++;
          }
          detailTableBody.appendChild(tr);
        });

        detailTable.appendChild(detailTableBody);

        return detailTable;
      }

      function editTable(isDetail, eTargetId, tdId) {

        var clickedTd = document.getElementById(tdId);

         var checkEditableInput = document.getElementById("editable-input");

        console.log("******",checkEditableInput,clickedTd, eTargetId, tdId)
        if (eTargetId !== '' && tdId !== '' && eTargetId === tdId && checkEditableInput === null) { 

          var editableInput = document.createElement("input");
          editableInput.setAttribute("id", "editable-input");
          editableInput.setAttribute("value", clickedTd.innerHTML);
          clickedTd.innerHTML = "";
          clickedTd.appendChild(editableInput);
         

        } else {

          var editableInput = document.getElementById("editable-input");

          editableInput.addEventListener("keyup", function (event) {
            if (event.keyCode === 13) {
              event.preventDefault();
              clickedTd.innerHTML = editableInput.value;
              editableInput.remove();
              editAjax(tdId.split("-")[0],tdId.split("-")[1])
            
            }
          });
          
          editableInput.addEventListener("mouseout", function (event) {
            clickedTd.innerHTML = editableInput.value;
            editableInput.remove();
            editAjax()
          });
        }
      }

      function editAjax(rowId, columnName){
        alert("id:" +  rowId + ", column: " +columnName)
      }
    </script>
  </body>
</html>
